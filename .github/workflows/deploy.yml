name: Deploy To EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Github Repository íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        uses: actions/checkout@v4

      - name: JDK 21ë²„ì „ ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./gradlew

      - name: application.yml íŒŒì¼ ë§Œë“¤ê¸°
        run: echo "${{ secrets.APPLICATION_PROPERTIES }}" > ./src/main/resources/application-secret.yml

      - name: í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œí•˜ê¸°
        run: ./gradlew clean build

      - name: ë¹Œë“œëœ íŒŒì¼ ì´ë¦„ ë³€ê²½í•˜ê¸°
        run: mv ./build/libs/*SNAPSHOT.jar ./project.jar

      - name: SCPë¡œ EC2ì— ë¹Œë“œëœ íŒŒì¼ ì „ì†¡í•˜ê¸°
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          source: project.jar
          target: /home/ubuntu/hoit-server/tobe

      - name: SSHë¡œ EC2ì— ì ‘ì†í•˜ì—¬ ë°°í¬í•˜ê¸°
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script_stop: true
          script: |
            echo "ğŸš€ ë°°í¬ ì‹œì‘..."
            
            # ë°ì´í„°ë² ì´ìŠ¤ ì»¨í…Œì´ë„ˆë“¤ì´ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ê³  ì‹œì‘
            cd /home/ubuntu/hoit-server
            if ! docker-compose ps | grep -q "Up"; then
              echo "ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘..."
              docker-compose up -d
              sleep 30
            else
              echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ì»¨í…Œì´ë„ˆë“¤ì´ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
            fi
            
            # midai ë°ì´í„°ë² ì´ìŠ¤ ì¡´ì¬ í™•ì¸ ë° ìƒì„±
            echo "ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ í™•ì¸ ì¤‘..."
            docker exec mysql_1 mysql -u root -phan1000llm -e "CREATE DATABASE IF NOT EXISTS midai;" 2>/dev/null || true
            
            # ê¸°ì¡´ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ
            echo "ğŸ›‘ ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ ì¤‘..."
            sudo fuser -k -n tcp 8090 || true
            sleep 5
            
            # ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ ì´ë™
            echo "ğŸ“¦ ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì¤‘..."
            rm -rf /home/ubuntu/hoit-server/current
            mkdir -p /home/ubuntu/hoit-server/current
            mv /home/ubuntu/hoit-server/tobe/project.jar /home/ubuntu/hoit-server/current/project.jar
            cd /home/ubuntu/hoit-server/current
            
            # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ëŒ€ê¸°
            echo "â³ ë°ì´í„°ë² ì´ìŠ¤ ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
            for i in {1..30}; do
              if docker exec mysql_1 mysql -u root -phan1000llm -e "SELECT 1;" >/dev/null 2>&1; then
                echo "âœ… MySQL ì—°ê²° ì„±ê³µ!"
                break
              fi
              echo "MySQL ì—°ê²° ëŒ€ê¸° ì¤‘... ($i/30)"
              sleep 2
            done
            
            # Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
            echo "ğŸš€ ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì¤‘..."
            nohup java -jar project.jar > ./output.log 2>&1 & 
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸°
            echo "â³ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
            sleep 45
            
            # í—¬ìŠ¤ì²´í¬
            echo "ğŸ” ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ í™•ì¸..."
            if curl -f http://localhost:8090/actuator/health >/dev/null 2>&1; then
              echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
            elif curl -f http://localhost:8090 >/dev/null 2>&1; then
              echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤! (í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ ì—†ìŒ)"
            else
              echo "âš ï¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
              echo "ğŸ“‹ ìµœê·¼ ë¡œê·¸:"
              tail -20 output.log
            fi
            
            # ì‹¤í–‰ ìƒíƒœ ìš”ì•½
            echo ""
            echo "ğŸ“Š ë°°í¬ ê²°ê³¼ ìš”ì•½:"
            echo "   - ë°ì´í„°ë² ì´ìŠ¤: $(docker-compose ps --format 'table {{.Name}}\t{{.Status}}' | grep -E '(mysql|redis|rabbit)' | wc -l)ê°œ ì„œë¹„ìŠ¤ ì‹¤í–‰ ì¤‘"
            echo "   - ì• í”Œë¦¬ì¼€ì´ì…˜: $(ps aux | grep 'java -jar project.jar' | grep -v grep | wc -l)ê°œ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ ì¤‘"
            echo "   - í¬íŠ¸ 8090: $(netstat -tlnp | grep ':8090 ' | wc -l)ê°œ ë¦¬ìŠ¤ë„ˆ"
            
            # ì •ë¦¬
            rm -rf /home/ubuntu/hoit-server/tobe
            
            echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"